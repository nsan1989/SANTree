{% extends 'index.html' %} {% load static %} {% block title %} Dashboard {% endblock %}
{% block start %} {% now "U" as now %}
<style>
  .dashboard-title h1 {
    font-family: 'Poppins', sans-serif;
    color: wheat;
    font-weight: bold;
  }

  .card {
    min-height: 8rem;
    align-items: center;
    justify-content: center;
    background-color: rgba(0, 0, 0, 0.4);
    color: #fff;
    font-family: "Poppins", sans-serif;
    font-size: 0.85rem;
  }

  .col-title,
  .chart-title {
    font-family: "Poppins", sans-serif;
    font-weight: bold;
    color: #fff;
  }

  th {
    font-family: "Poppins", sans-serif;
    font-size: 1rem;
  }

  tr {
    font-family: "Poppins", sans-serif;
    font-size: 0.9rem;
  }

  a {
    text-decoration: none;
  }

  .add-department small a:hover,
  .add-complaint small a:hover,
  .add-task small a:hover,
  .add-location small a:hover,
  .add-service small a:hover,
  .add-block small a:hover {
    background-color: rgba(255, 193, 7, 0.6);
    text-decoration: none;
  }

  .card-link a {
    color: orange;
  }

  .card-link a:hover {
    color: green;
  }
</style>

<link rel="stylesheet" href="{% static 'styles/san_tree.css' %}" />

<div class="container-fluid h-100">
  <div class="row mb-3">
    <div class="col-12">
      <div class="dashboard-title">
        <h1 class="mb-0">Dashboard</h1>
      </div>
      <div class="user-title">
        <p class="mb-0">{{user.username}}</p>
      </div>
    </div>
  </div>
  <div class="row mb-3 px-2">
    <div class="col-2 p-1">
      <div class="add-department">
        <small>
          <a class="open-modal text-warning d-flex align-items-center justify-content-center border border-warning rounded"
            href="#" data-url="{% url 'add_department' %}">
            <i class="fa-solid fa-plus fa-sm"></i>
            &nbsp; <small>add dept.</small>
          </a>
        </small>
      </div>
    </div>
    <div class="col-2 p-1">
      <div class="add-complaint">
        <small>
          <a class="open-modal text-warning d-flex align-items-center justify-content-center border border-warning rounded"
            href="#" data-url="{% url 'add_complaint_type' %}">
            <i class="fa-solid fa-plus fa-sm"></i>
            &nbsp; <small>add comp.</small>
          </a>
        </small>
      </div>
    </div>
    <div class="col-2 p-1">
      <div class="add-task">
        <small>
          <a class="open-modal text-warning d-flex align-items-center justify-content-center border border-warning rounded"
            href="#" data-url="{% url 'add_task_type' %}">
            <i class="fa-solid fa-plus fa-sm"></i>
            &nbsp; <small>add task</small>
          </a>
        </small>
      </div>
    </div>
    <div class="col-2 p-1">
      <div class="add-location">
        <small>
          <a class="open-modal text-warning d-flex align-items-center justify-content-center border border-warning rounded"
            href="#" data-url="{% url 'add_location' %}">
            <i class="fa-solid fa-plus fa-sm"></i>
            &nbsp; <small>add Loc.</small>
          </a>
        </small>
      </div>
    </div>
    <div class="col-2 p-1">
      <div class="add-service">
        <small>
          <a class="open-modal text-warning d-flex align-items-center justify-content-center border border-warning rounded"
            href="#" data-url="{% url 'add_service_type' %}">
            <i class="fa-solid fa-plus fa-sm"></i>
            &nbsp; <small>add serv.</small>
          </a>
        </small>
      </div>
    </div>
    <div class="col-2 p-1">
      <div class="add-block">
        <small>
          <a class="open-modal text-warning d-flex align-items-center justify-content-center border border-warning rounded"
            href="#" data-url="{% url 'add_block' %}">
            <i class="fa-solid fa-plus fa-sm"></i>
            &nbsp; <small>add blocks</small>
          </a>
        </small>
      </div>
    </div>
  </div>
  <div class="row g-2 mb-3">
    <div class="col-xs-12 col-sm-12 col-md-3 col-lg-3 col-xl-3">
      <div class="card shadow-sm">
        <div class="card-title">
          <h5>Total Users</h5>
        </div>
        <div class="card-content">
          {{user}}
        </div>
        <div class="card-link">
          <a href="{% url 'all_users' %}"
            style="text-decoration: none;font-family: 'Poppins', sans-serif;">
            View All
          </a>
        </div>
      </div>
    </div>
    <div class="col-xs-12 col-sm-12 col-md-3 col-lg-3 col-xl-3">
      <div class="card shadow-sm">
        <div class="card-title">
          <h5>Total Departments</h5>
        </div>
        <div class="card-content">
          {{dept}}
        </div>
        <div class="card-link">
          <a href="{% url 'all_departments' %}"
            style="text-decoration: none;font-family: 'Poppins', sans-serif;">
            View All
          </a>
        </div>
      </div>
    </div>
    <div class="col-xs-12 col-sm-12 col-md-3 col-lg-3 col-xl-3">
      <div class="card shadow-sm">
        <div class="card-title">
          <h5>Total Complaints</h5>
        </div>
        <div class="card-content">
          {{comp}}
        </div>
        <div class="card-link">
          <a href="{% url 'all_complaints' %}"
            style="text-decoration: none;font-family: 'Poppins', sans-serif;">
            View All
          </a>
        </div>
      </div>
    </div>
    <div class="col-xs-12 col-sm-12 col-md-3 col-lg-3 col-xl-3">
      <div class="card shadow-sm">
        <div class="card-title">
          <h5>Total Tasks</h5>
        </div>
        <div class="card-content">
          {{task}}
        </div>
        <div class="card-link">
          <a href="{% url 'all_tasks' %}"
            style="text-decoration: none;font-family: 'Poppins', sans-serif;">
            View All
          </a>
        </div>
      </div>
    </div>
  </div>
  <div class="row g-2 mb-3 pb-3">
    <div class="col-xs-12 col-sm-12 col-md-6 col-lg-6 col-xl-6">
      <img class="img-fluid w-100 rounded-2" src="{% url 'all_complaints_pie_chart' %}?v={{ now }}"
        alt="Dept. Complaint Pie Chart" />
    </div>
    <div class="col-xs-12 col-sm-12 col-md-6 col-lg-6 col-xl-6">
      <img class="img-fluid w-100 rounded-2" src="{% url 'all_tasks_pie_chart' %}?v={{ now }}"
        alt="Dept. Complaint Pie Chart" />
    </div>
  </div>
</div>

<!--Modal Block-->
<div class="modal fade" id="dynamicModal" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
  <div class="modal-dialog modal-sm"> <!-- Adjust size as needed -->
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body w-100" id="modalBody">
        <!-- Content loads here -->
      </div>
    </div>
  </div>
</div>
<!--------------->

<!--Open Modal Script-->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const modalElement = document.getElementById('dynamicModal');
    const modalBody = document.getElementById('modalBody');
    document.querySelectorAll('.open-modal').forEach(function (el) {
      el.addEventListener('click', function (e) {
        e.preventDefault();
        const url = this.getAttribute('data-url');

        // Fetch content and show modal
        fetch(url)
          .then(response => response.text())
          .then(html => {
            modalBody.innerHTML = html;
            const modal = new bootstrap.Modal(modalElement);
            modal.show();

            // Attach form handler AFTER modal content loads
            const form = modalBody.querySelector('form');
            if (form) {
              form.addEventListener('submit', function (e) {
                e.preventDefault();

                const formData = new FormData(form);
                fetch(form.action, {
                  method: 'POST',
                  body: formData,
                  headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                  }
                })
                  .then(response => {
                    // If redirected (success), reload or redirect
                    if (response.redirected) {
                      window.location.href = response.url;
                    } else {
                      return response.text().then(html => {
                        modalBody.innerHTML = html; // re-render form if error
                      });
                    }
                  })
                  .catch(error => {
                    modalBody.innerHTML = '<div class="alert alert-danger">Error submitting form.</div>';
                  });
              });
            }
          })
          .catch(error => {
            modalBody.innerHTML = '<p>Error loading content.</p>';
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
          });
      });
    });
  });
</script>
{% endblock %}