{% extends 'index.html' %} 
{% load timesince_extra %}

{% block title %} 
My Tasks
{% endblock %} 

{% block start %}

<style>
  .my-tasks-title h1 {
    font-family: 'Poppins', sans-serif;
    color: wheat;
  }
  th {
    font-family: 'Poppins', sans-serif;
    font-size: 0.9rem;
    font-weight: bold;
  }
  tr {
    font-family: 'Poppins', sans-serif;
    font-size: 0.85rem;
  }
</style>

<div class="container-fluid">
  <div class="row">
    <div class="col-12 my-tasks-title">
      <h1 class="fw-bold py-2">My Tasks</h1>
    </div>
  </div>
  <div class="row">
    <div class="col-12 task-table">
      <div class="table-responsive">
        <table class="table table-bordered">
          <thead class="table-dark">
            <tr>
              <th scope="col">Tasks No.</th>
              <th scope="col">Tasks</th>
              <th scope="col">Location</th>
              <th scope="col">Status</th>
              <th scope="col">Completed At</th>
              <th scope="col">TAT</th>
              <th scope="col">Remark</th>
              <th scope="col">Details</th>
            </tr>
          </thead>
          <tbody class="table-primary">
            {% if tasks %} {% for task in tasks %}
            <tr>
              <td>{{ task.tasks_number}}</td>
              <td>{{ task.tasks_types.name }}</td>
              <td>{{ task.location }}</td>
              <td>{{ task.status }}</td>
              <td>{{ task.completed_at }}</td>
              <td>{{ task.time_taken|duration_display }}</td>
              {% if task.status != 'Waiting' and task.status != 'Completed' %}
              <td class="text-center"><a class="open-modal" data-url="{% url 'tms:tasks_remarks' task.id %}"><i class="fa-solid fa-pen"></i></a></td>
              {% else %}
              <td>--</td>
              {% endif %}
              <td>
                <a href="{% url 'tms:staff_tasks_details' task.id %}"><i class="fa-solid fa-eye"></i></a>
              </td>
            </tr>
            {% endfor %} {% else %}
            <tr>
              <td colspan="9">
                No tasks have been assigned yet!
              </td>
            </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!--Modal Block-->
<div class="modal fade" id="dynamicModal" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
  <div class="modal-dialog modal-sm"> <!-- Adjust size as needed -->
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body w-100" id="modalBody">
        <!-- Content loads here -->
      </div>
    </div>
  </div>
</div>
<!--------------->

<!--Open Modal Script-->
<script>
document.addEventListener('DOMContentLoaded', function () {
  const modalElement = document.getElementById('dynamicModal');
  const modalBody = document.getElementById('modalBody');
  document.querySelectorAll('.open-modal').forEach(function (el) {
    el.addEventListener('click', function (e) {
      e.preventDefault();
      const url = this.getAttribute('data-url');

      // Fetch content and show modal
      fetch(url)
        .then(response => response.text())
        .then(html => {
          modalBody.innerHTML = html;
          const modal = new bootstrap.Modal(modalElement);
          modal.show();

          // Attach form handler AFTER modal content loads
          const form = modalBody.querySelector('form');
          if (form) {
            form.addEventListener('submit', function (e) {
              e.preventDefault();

              const formData = new FormData(form);
              fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                  'X-Requested-With': 'XMLHttpRequest',
                }
              })
              .then(response => {
                // If redirected (success), reload or redirect
                if (response.redirected) {
                  window.location.href = response.url;
                } else {
                  return response.text().then(html => {
                    modalBody.innerHTML = html; // re-render form if error
                  });
                }
              })
              .catch(error => {
                modalBody.innerHTML = '<div class="alert alert-danger">Error submitting form.</div>';
              });
            });
          }
        })
        .catch(error => {
          modalBody.innerHTML = '<p>Error loading content.</p>';
          const modal = new bootstrap.Modal(modalElement);
          modal.show();
        });
    });
  });
});
</script>
{% endblock %}
